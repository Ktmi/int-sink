phony += all

dep-bpf := $(obj-bpf:.bpf.o=.bpf.d)

$(dep-bpf): %.bpf.d: %.c
	$(COMPILE.test.c) $< -M -MT '$(@:.d=.o) $@' > $@

include $(dep-bpf)

target-bpf := $(target-skel:.skel.h=.bpf.o)

all: $(target-skel)

$(target-skel): %.skel.h: %.bpf.o
	$(BPFTOOL) gen skel $< > $@

$(target-bpf): $(obj-bpf)
	$(BPFTOOL) gen object $@ $^

$(obj-bpf): %.bpf.o: %.c $(OBJECT_LIBBPF) $(OUTPUT_DIR)/vmlinux.h
	$(COMPILE.bpf.c) $(OUTPUT_OPTION) $<

%.bpf.ll: %.c $(OBJECT_LIBBPF) $(OUTPUT_DIR)/vmlinux.h
	$(COMPILE.bpf.c) -emit-llvm $(OUTPUT_OPTION) $<

phony += clean

clean-targets += $(target-skel) $(target-bpf) $(obj-bpf) $(dep-bpf)

clean:
	-rm -f $(clean-targets)

.PHONY: $(phony)

.DELETE_ON_ERROR:

.SECONDARY: